(window.webpackJsonp=window.webpackJsonp||[]).push([[222],{574:function(e,t,r){"use strict";r.r(t);var a=r(16),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"加载第三方-javascript"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#加载第三方-javascript"}},[e._v("#")]),e._v(" 加载第三方 JavaScript")]),e._v(" "),r("p",[e._v("您已经优化了所有代码，但是网站加载仍然太慢。谁是罪魁祸首？")]),e._v(" "),r("p",[e._v("通常，导致网页变慢的性能问题是由于第三方脚本引起的：广告，分析，跟踪器，社交媒体按钮等。")]),e._v(" "),r("p",[e._v("第三方脚本提供了广泛的有用功能，使 Web 更具动态性，交互性和互连性。这些脚本可能对您网站的功能或收入来源至关重要。但是第三方脚本还带有"),r("strong",[e._v("许多风险")]),e._v("，应在"),r("strong",[e._v("最大程度地降低其影响的")]),e._v("同时仍提供价值。")]),e._v(" "),r("p",[e._v("为什么您需要 "),r("a",{attrs:{href:"https://css-tricks.com/potential-dangers-of-third-party-javascript/",target:"_blank",rel:"noopener noreferrer"}},[e._v("注意"),r("OutboundLink")],1),e._v(" 第三方脚本？")]),e._v(" "),r("ul",[r("li",[e._v("它们可能是"),r("strong",[e._v("性能")]),e._v("问题")]),e._v(" "),r("li",[e._v("它们可能是"),r("strong",[e._v("隐私")]),e._v("问题")]),e._v(" "),r("li",[e._v("它们可能是"),r("strong",[e._v("安全")]),e._v("问题")]),e._v(" "),r("li",[e._v("它们可能无法"),r("strong",[e._v("预测")]),e._v("并且会在您不知情的情况下发生变化")]),e._v(" "),r("li",[e._v("他们可能会产生"),r("strong",[e._v("意想不到的后果")])])]),e._v(" "),r("p",[e._v("理想情况下，您将要确保第三方脚本不会影响"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/critical-rendering-path",target:"_blank",rel:"noopener noreferrer"}},[e._v("关键的渲染路径"),r("OutboundLink")],1),e._v("。在本指南中，我们将逐步介绍如何查找和修复与加载第三方 JavaScript 有关的问题。")]),e._v(" "),r("h2",{attrs:{id:"第三方脚本是什么意思"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第三方脚本是什么意思"}},[e._v("#")]),e._v(" 第三方脚本是什么意思？")]),e._v(" "),r("p",[e._v("第三方 JavaScript 通常是指可以直接从第三方供应商嵌入任何站点的脚本。这些脚本可以包括广告，分析，小部件和其他脚本，这些脚本可以使网络更加动态和交互式。")]),e._v(" "),r("p",[e._v("第三方脚本的示例包括：")]),e._v(" "),r("ul",[r("li",[e._v("社交分享按钮（例如 Twitter，Facebook，G +）")]),e._v(" "),r("li",[e._v("嵌入视频播放器（例如 YouTube，Vimeo）")]),e._v(" "),r("li",[e._v("广告 iframe")]),e._v(" "),r("li",[e._v("分析和指标脚本")]),e._v(" "),r("li",[e._v("用于实验的 A / B 测试脚本")]),e._v(" "),r("li",[e._v("助手库（例如日期格式，动画，功能库等）")])]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_0.jpg",alt:"嵌入youtube视频的示例"}})]),e._v(" "),r("div",{staticClass:"language-html extra-class"},[r("pre",{pre:!0,attrs:{class:"language-html"}},[r("code",[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("iframe")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("width")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("560"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("height")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("315"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("src")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("https://www.youtube.com/embed/mo8thg5XGV0"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("frameborder")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("0"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("allow")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("autoplay; encrypted-media"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("allowfullscreen")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" "),r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("</")]),e._v("iframe")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v("\n")])])]),r("p",[e._v("YouTube 视频播放器的嵌入脚本就是其中的一个示例，该脚本可让您将视频嵌入页面中。")]),e._v(" "),r("p",[e._v("不幸的是，嵌入第三方脚本意味着我们经常依靠它们来快速运行，以避免减慢页面速度。第三方脚本是导致性能下降的主要原因，并且通常是由您无法控制的资源引起的。")]),e._v(" "),r("p",[e._v("这些问题可能包括：")]),e._v(" "),r("ul",[r("li",[e._v("向多个服务器发出过多的网络请求。网站提出的请求越多，加载时间就越长。")]),e._v(" "),r("li",[e._v("发送"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/javascript-startup-optimization",target:"_blank",rel:"noopener noreferrer"}},[e._v("太多的 JavaScript"),r("OutboundLink")],1),e._v(" ，使主线程忙。太多的 JavaScript 会阻止 DOM 的构建，从而延迟了页面呈现的速度。占用大量 CPU 的脚本的解析和执行可能会延迟用户交互并导致电池消耗。")]),e._v(" "),r("li",[e._v("发送"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/unoptimized-images",target:"_blank",rel:"noopener noreferrer"}},[e._v("未经优化的"),r("OutboundLink")],1),e._v("大型"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/unoptimized-images",target:"_blank",rel:"noopener noreferrer"}},[e._v("图像文件"),r("OutboundLink")],1),e._v("或视频。这会消耗数据并花费用户金钱。")]),e._v(" "),r("li",[e._v("随意加载第三方脚本可能是"),r("a",{attrs:{href:"http://blog.patrickmeenan.com/2011/10/testing-for-frontend-spof.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("单点故障"),r("OutboundLink")],1),e._v(" （SPOF）")]),e._v(" "),r("li",[r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/http-caching",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP 缓存"),r("OutboundLink")],1),e._v("不足，经常迫使从网络中获取资源")]),e._v(" "),r("li",[e._v("缺乏足够的"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/optimize-encoding-and-transfer",target:"_blank",rel:"noopener noreferrer"}},[e._v("服务器"),r("OutboundLink")],1),e._v(" 资源"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/optimize-encoding-and-transfer",target:"_blank",rel:"noopener noreferrer"}},[e._v("压缩"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("阻止内容显示，直到它们完成处理。对于异步 A / B 测试脚本也是如此。")]),e._v(" "),r("li",[e._v("使用已知对用户体验"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/document-write",target:"_blank",rel:"noopener noreferrer"}},[e._v("有害"),r("OutboundLink")],1),e._v("的旧版 API（例如 "),r("a",{attrs:{href:"https://developers.google.cn/web/updates/2016/08/removing-document-write",target:"_blank",rel:"noopener noreferrer"}},[e._v("document.write（）"),r("OutboundLink")],1),e._v("）")]),e._v(" "),r("li",[e._v("过多的 DOM 元素或昂贵的 CSS 选择器。")]),e._v(" "),r("li",[e._v("包括多个第三方嵌入会导致多个框架和库被拉多次。这是浪费的，并且加剧了性能问题。")]),e._v(" "),r("li",[e._v("第三方脚本通常使用嵌入技术， 即使它们的服务器响应缓慢，即使它们使用的是异步或延迟，它们也会阻止 "),r("a",{attrs:{href:"https://developer.mozilla.org/en/docs/Web/API/GlobalEventHandlers/onload",target:"_blank",rel:"noopener noreferrer"}},[e._v("window.onload"),r("OutboundLink")],1),e._v("。")])]),e._v(" "),r("p",[e._v("上下文很重要，而代价高昂的第三方的解决方案可能取决于您的站点以及配置如何加载第三方代码的能力。值得庆幸的是，存在许多解决方案和工具来查找和修复第三方资源的问题。")]),e._v(" "),r("h2",{attrs:{id:"您如何识别页面上的第三方脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#您如何识别页面上的第三方脚本"}},[e._v("#")]),e._v(" 您如何识别页面上的第三方脚本？")]),e._v(" "),r("p",[e._v("除非您知道站点加载了哪些第三方脚本及其对性能的影响，否则无法知道如何对其进行优化。许多免费的网络速度测试工具可以突出显示昂贵的第三方，包括"),r("a",{attrs:{href:"https://developer.chrome.com/devtools",target:"_blank",rel:"noopener noreferrer"}},[e._v("Chrome DevTools"),r("OutboundLink")],1),e._v("，"),r("a",{attrs:{href:"https://developers.google.cn/speed/pagespeed/insights",target:"_blank",rel:"noopener noreferrer"}},[e._v("PageSpeed Insights"),r("OutboundLink")],1),e._v("和 "),r("a",{attrs:{href:"https://www.webpagetest.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("WebPageTest"),r("OutboundLink")],1),e._v("。这些工具显示丰富的诊断信息，这些信息可以告诉您您的站点加载"),r("em",[e._v("了多少")]),e._v("个第三方脚本，并且执行时间最多。")]),e._v(" "),r("p",[e._v("WebPageTest 的瀑布视图可以突出显示大量使用第三方脚本的影响。以下是加载网站主要内容所需的请求与跟踪和营销脚本的关系的示例（来源："),r("a",{attrs:{href:"https://nystudio107.com/blog/tags-gone-wild",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tags Gone Wild"),r("OutboundLink")],1),e._v("）。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_2.jpg",alt:"来自webpagetest的瀑布视图，显示了实际的网站与加载跟踪脚本所花费的时间"}})]),e._v(" "),r("p",[e._v("WebPageTest 的"),r("a",{attrs:{href:"https://www.google.com/url?q=https://www.webpagetest.org/result/180222_J4_8fee6855d6f45719e4f37d8d89ecbc20/1/domains/&sa=D&ust=1519325015196000&usg=AFQjCNGrRivilJS9yqqpombsUMQZQJx2nw",target:"_blank",rel:"noopener noreferrer"}},[e._v("域细分"),r("OutboundLink")],1),e._v(" 对于可视化来自第三方来源的内容也很有用。它按总字节数和请求数将其细分：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_3.png",alt:"内容按域细分（第一个视图）。 显示每个第三方的请求数和字节数"}})]),e._v(" "),r("p",[e._v("当您看到有问题的脚本时，请弄清楚该脚本的作用，并问自己脚本是否真的必要。进行 A / B 测试，以平衡感知到的价值及其对关键用户参与或绩效指标的影响。")]),e._v(" "),r("h3",{attrs:{id:"chrome-devtools-第三方脚本标记"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#chrome-devtools-第三方脚本标记"}},[e._v("#")]),e._v(" Chrome DevTools 第三方脚本标记")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools",target:"_blank",rel:"noopener noreferrer"}},[e._v("Chrome DevTools"),r("OutboundLink")],1),e._v("支持在“ "),r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools/network-performance/resource-loading",target:"_blank",rel:"noopener noreferrer"}},[e._v("网络”面板中"),r("OutboundLink")],1),e._v("突出显示第三方（按产品名称）。这使您可以更深入地了解第三方在页面上发出请求，登录到控制台并在页面上执行昂贵的 JavaScript。")]),e._v(" "),r("p",[e._v("要显示第三方徽章，请导航至 Chrome DevTools 中的任何面板，然后按 CMD + Shift + P 弹出命令菜单。接下来，输入“显示第三方徽章”。这将启用该功能：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_4.png",alt:"从DevTools命令菜单启用对第三方徽章功能的支持"}})]),e._v(" "),r("p",[e._v("现在，当您使用“网络”面板记录页面加载时，它将包含第三方标志，例如下面以绿色显示的“ AOL 广告”标志。将鼠标悬停在“网络”面板中的第三方徽章上将显示有关该脚本的更多信息，从而帮助您确定其作用。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_5.png",alt:"网络面板中的DevTools第三方徽章"}})]),e._v(" "),r("h2",{attrs:{id:"如何衡量第三方脚本对页面的影响"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#如何衡量第三方脚本对页面的影响"}},[e._v("#")]),e._v(" 如何衡量第三方脚本对页面的影响？")]),e._v(" "),r("h3",{attrs:{id:"灯塔启动时间审核"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#灯塔启动时间审核"}},[e._v("#")]),e._v(" 灯塔启动时间审核")]),e._v(" "),r("p",[e._v("Lighthouse "),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/bootup",target:"_blank",rel:"noopener noreferrer"}},[e._v("JavaScript 启动时间审核"),r("OutboundLink")],1),e._v("突出显示了具有昂贵的脚本解析，编译或评估时间的脚本。这对于发现占用大量 CPU 的第三方脚本很有用。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_6.png",alt:"Lighthouse显示了对脚本评估和解析的支持"}})]),e._v(" "),r("h3",{attrs:{id:"灯塔网络有效负载审计"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#灯塔网络有效负载审计"}},[e._v("#")]),e._v(" 灯塔网络有效负载审计")]),e._v(" "),r("p",[e._v("Lighthouse "),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/network-payloads",target:"_blank",rel:"noopener noreferrer"}},[e._v("Network 有效"),r("OutboundLink")],1),e._v("负载"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/network-payloads",target:"_blank",rel:"noopener noreferrer"}},[e._v("审核可"),r("OutboundLink")],1),e._v("识别可能会减慢页面加载时间的网络请求（包括来自第三方的请求）。避免这些请求或突出其对广告网络的成本，可以为用户节省本应花在蜂窝数据上的钱。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_18.png",alt:"灯塔显示对大型网络有效负载的支持"}})]),e._v(" "),r("h3",{attrs:{id:"chrome-devtools-网络请求阻止"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#chrome-devtools-网络请求阻止"}},[e._v("#")]),e._v(" Chrome DevTools 网络请求阻止")]),e._v(" "),r("p",[e._v("Chrome DevTools 可让您查看在没有特定脚本，样式表或其他资源时页面的行为。这是通过"),r("a",{attrs:{href:"https://developers.google.cn/web/updates/2017/04/devtools-release-notes#block-requests",target:"_blank",rel:"noopener noreferrer"}},[e._v("网络请求阻止完成的"),r("OutboundLink")],1),e._v("，该功能可以帮助衡量阻止（丢弃）页面中特定第三方资源的影响。")]),e._v(" "),r("p",[e._v("要启用请求阻止，请右键单击“网络”面板中的任何请求，然后选择“阻止请求 URL”。“请求阻止”选项卡将显示在 DevTools 抽屉中，让您管理哪些请求已被阻止。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_7.png",alt:"从DevTools网络面板阻止请求URL"}})]),e._v(" "),r("h3",{attrs:{id:"chrome-devtools-性能面板"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#chrome-devtools-性能面板"}},[e._v("#")]),e._v(" Chrome DevTools 性能面板")]),e._v(" "),r("p",[e._v("Chrome DevTools 中的“效果"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools/evaluate-performance/reference",target:"_blank",rel:"noopener noreferrer"}},[e._v("”面板"),r("OutboundLink")],1),e._v("可帮助您确定网页的网络性能问题。单击“记录”按钮并加载页面，将向您展示一个瀑布，代表您的网站在哪里花费时间。在“性能”面板的底部，您将看到一个以“ "),r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools/evaluate-performance/reference#record-load",target:"_blank",rel:"noopener noreferrer"}},[e._v("摘要"),r("OutboundLink")],1),e._v(" ” 开头的抽屉。导航到“自下而上”选项卡。")]),e._v(" "),r("p",[e._v("在这里，您可以使用“自下而上”选项卡中的“按产品分组”选项将第三方花费的时间进行分组。这有助于确定哪些第三方产品成本最高。“ "),r("a",{attrs:{href:"https://umaar.com/dev-tips/143-network-products/",target:"_blank",rel:"noopener noreferrer"}},[e._v("网络”面板"),r("OutboundLink")],1),e._v("还支持按产品突出显示请求的选项。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_8.png",alt:"DevTools Performance面板显示了按（第三方）产品分组的自下而上视图"}})]),e._v(" "),r("p",[e._v("要了解有关如何使用 Chrome DevTools 分析页面加载性能的更多信息，请参阅"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools/evaluate-performance",target:"_blank",rel:"noopener noreferrer"}},[e._v("分析运行时性能入门"),r("OutboundLink")],1),e._v("。")]),e._v(" "),r("p",[e._v("衡量第三方脚本影响的良好"),r("strong",[e._v("工作流程")]),e._v("是：")]),e._v(" "),r("ul",[r("li",[e._v("使用“网络”面板测量加载页面所需的时间。\n"),r("ul",[r("li",[e._v("为了模拟实际情况，我们建议打开"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/chrome-devtools/network-performance#emulate",target:"_blank",rel:"noopener noreferrer"}},[e._v("网络限制"),r("OutboundLink")],1),e._v("和 "),r("a",{attrs:{href:"https://developers.google.cn/web/updates/2017/07/devtools-release-notes#throttling",target:"_blank",rel:"noopener noreferrer"}},[e._v("CPU 限制"),r("OutboundLink")],1),e._v("。在更快的连接速度和桌面硬件上，昂贵的脚本的影响可能不像在手机上那样具有代表性。")])])]),e._v(" "),r("li",[e._v("阻止负责您认为是问题的第三方脚本的 URL 或域（请参阅"),r("em",[e._v("Chrome DevTools 性能面板")]),e._v("以识别昂贵的脚本）。")]),e._v(" "),r("li",[e._v("重新加载页面并重新测量页面花费的时间，而无需加载这些被阻止的第三方脚本。希望您会看到改善。\n"),r("ul",[r("li",[e._v("进行 3 次或更多次测量并查看中位数以获得更稳定的数字可能会有价值。由于第三方内容偶尔会在每次页面加载时提取不同的资源，因此这可能使您的传播更为现实。"),r("a",{attrs:{href:"https://twitter.com/ChromeDevTools/status/963820146388221952",target:"_blank",rel:"noopener noreferrer"}},[e._v("现在，DevTools"),r("OutboundLink")],1),e._v(" 在性能面板中"),r("a",{attrs:{href:"https://twitter.com/ChromeDevTools/status/963820146388221952",target:"_blank",rel:"noopener noreferrer"}},[e._v("支持多个录制"),r("OutboundLink")],1),e._v("，这使操作变得更加简单。")])])])]),e._v(" "),r("h3",{attrs:{id:"使用-webpagetest-测量第三方标签的影响"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用-webpagetest-测量第三方标签的影响"}},[e._v("#")]),e._v(" 使用 WebPageTest 测量第三方标签的影响")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.webpagetest.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("WebPageTest"),r("OutboundLink")],1),e._v("支持阻止单个请求的加载（这对于阻止广告和第三方嵌入之类的内容很有用）以衡量其影响。")]),e._v(" "),r("p",[e._v("在“高级设置”下是“阻止”选项卡。这可以用来指定要阻止的域的列表，模拟根本不加载的情况。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_9.png",alt:"WebPageTest高级设置<阻止。 显示用于指定要阻止的域的文本区域。"}})]),e._v(" "),r("p",[e._v("使用此功能的工作流程是：")]),e._v(" "),r("ul",[r("li",[e._v("正常测试页面")]),e._v(" "),r("li",[e._v("在某些第三方被阻止的情况下重复测试")]),e._v(" "),r("li",[e._v("比较两个结果（注意胶片）。可以通过从“ "),r("a",{attrs:{href:"https://www.webpagetest.org/testlog/1/",target:"_blank",rel:"noopener noreferrer"}},[e._v("测试历史记录"),r("OutboundLink")],1),e._v(" ”中选择结果并单击“比较”来比较结果。")])]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_10.png",alt:"WebPageTest显示比较选项，使您可以比较两个报告"}})]),e._v(" "),r("p",[e._v("在下面，我们可以看到在有和没有第三方资源被阻止的情况下，幻灯片之间的区别。尝试对各个第三方来源进行尝试，以确定哪些对您的页面加载性能影响最大：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_11.png",alt:"WebPageTest幻灯片显示了在加载和禁用第三方的情况下加载网站的影响"}})]),e._v(" "),r("p",[e._v("安迪·戴维斯（Andy Davies）的“ "),r("a",{attrs:{href:"https://goo.gl/jwGg6X",target:"_blank",rel:"noopener noreferrer"}},[e._v("使用 WebPageTest 来衡量第三方标签的影响"),r("OutboundLink")],1),e._v(" ”中"),r("a",{attrs:{href:"https://goo.gl/jwGg6X",target:"_blank",rel:"noopener noreferrer"}},[e._v("使用"),r("OutboundLink")],1),e._v(" WPT 的“阻止请求”功能阻止页面上第三方资源"),r("a",{attrs:{href:"https://goo.gl/jwGg6X",target:"_blank",rel:"noopener noreferrer"}},[e._v("的影响"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("**注意：**WebPageTest 还支持在 DNS 级别运行的两个命令来阻止域。 "),r("a",{attrs:{href:"https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/scripting#TOC-blockDomains",target:"_blank",rel:"noopener noreferrer"}},[e._v("blockDomains-"),r("OutboundLink")],1),e._v(" 接受要阻止的域的列表，而"),r("a",{attrs:{href:"https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/scripting#TOC-blockDomainsExcept",target:"_blank",rel:"noopener noreferrer"}},[e._v("blockDomainsExcept-"),r("OutboundLink")],1),e._v(" 接受要阻止的域 的列表，并阻止列表中没有的任何内容。")]),e._v(" "),r("p",[e._v("WebPageTest 还具有单点故障（SPOF）选项卡。这使您可以模拟超时或完全失败以加载资源。")]),e._v(" "),r("p",[e._v("“ SPOF”和“块”之间的区别是 SPOF 缓慢超时。这对于测试第三方内容的网络弹性很有用，它可以确定当服务处于高负载或暂时不可用时页面保持的状态。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_12.png",alt:"WebPageTest高级设置> SPOF>主机失败"}})]),e._v(" "),r("h3",{attrs:{id:"使用-长任务-检测昂贵的-iframe"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用-长任务-检测昂贵的-iframe"}},[e._v("#")]),e._v(" 使用“长任务”检测昂贵的 iframe")]),e._v(" "),r("p",[e._v("当第三方 iframe 中的脚本需要很长时间才能运行时，它们会阻塞主线程，从而延迟其他任务的运行。这些漫长的任务可能导致不良的用户体验，从而导致事件处理程序缓慢或丢帧。")]),e._v(" "),r("p",[e._v("为了检测长期任务的"),r("a",{attrs:{href:"https://en.wikipedia.org/wiki/Real_user_monitoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("真实用户监控"),r("OutboundLink")],1),e._v("（RUM），我们可以使用 JavaScript "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver",target:"_blank",rel:"noopener noreferrer"}},[e._v("PerformanceObserver"),r("OutboundLink")],1),e._v(" API 和观察 "),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/user-centric-performance-metrics#long_tasks",target:"_blank",rel:"noopener noreferrer"}},[e._v("longtask"),r("OutboundLink")],1),e._v(" 条目。由于这些条目包含归因属性，因此我们可以跟踪哪个帧上下文负责该任务。")]),e._v(" "),r("p",[e._v("下面是一个示例，该示例会将"),r("code",[e._v("longtask")]),e._v("条目记录到控制台，包括一个用于“昂贵” iframe 的条目：")]),e._v(" "),r("div",{staticClass:"language-html extra-class"},[r("pre",{pre:!0,attrs:{class:"language-html"}},[r("code",[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("script")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),r("span",{pre:!0,attrs:{class:"token script"}},[r("span",{pre:!0,attrs:{class:"token language-javascript"}},[e._v("\n  "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" observer "),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("PerformanceObserver")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("list")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" entry "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("of")]),e._v(" list"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("getEntries")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),r("span",{pre:!0,attrs:{class:"token comment"}},[e._v('// Attribution entry including "containerSrc":"https://example.com"')]),e._v("\n      console"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token constant"}},[e._v("JSON")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("stringify")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("entry"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("attribution"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n  observer"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("observe")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" entryTypes"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),r("span",{pre:!0,attrs:{class:"token string"}},[e._v("'longtask'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("</")]),e._v("script")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v("\n\n"),r("span",{pre:!0,attrs:{class:"token comment"}},[e._v("\x3c!-- Imagine this is an iframe with expensive long tasks --\x3e")]),e._v("\n"),r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("iframe")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("src")]),r("span",{pre:!0,attrs:{class:"token attr-value"}},[r("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("https://example.com"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token tag"}},[r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("</")]),e._v("iframe")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v("\n")])])]),r("p",[e._v("要了解有关监视长任务的更多信息，请阅读 Phil Walton 的以"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/user-centric-performance-metrics#long_tasks",target:"_blank",rel:"noopener noreferrer"}},[e._v("用户为中心的性能指标"),r("OutboundLink")],1),e._v("。")]),e._v(" "),r("h2",{attrs:{id:"您如何有效地加载第三方脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#您如何有效地加载第三方脚本"}},[e._v("#")]),e._v(" 您如何有效地加载第三方脚本？")]),e._v(" "),r("p",[e._v("如果第三方脚本正在减慢页面加载速度，则可以使用以下几种方法来提高性能：")]),e._v(" "),r("ul",[r("li",[e._v("使用 async 或 defer 属性加载脚本，以避免阻止文档解析。")]),e._v(" "),r("li",[e._v("如果第三方服务器运行缓慢，请考虑自托管脚本。")]),e._v(" "),r("li",[e._v("如果脚本没有为您的网站增加明显的价值，请考虑删除该脚本。")]),e._v(" "),r("li",[e._v("考虑使用"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/resource-prioritization#preconnect",target:"_blank",rel:"noopener noreferrer"}},[e._v("资源提示"),r("OutboundLink")],1),e._v("， "),r("code",[e._v("或")]),e._v("为托管第三方脚本的域执行 DNS 查找。")])]),e._v(" "),r("h3",{attrs:{id:"使用异步或延迟"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用异步或延迟"}},[e._v("#")]),e._v(" 使用异步或延迟")]),e._v(" "),r("p",[e._v("JavaScript 执行是解析器阻止。这意味着当浏览器遇到脚本时，它必须暂停 DOM 构建，将其移交给 JavaScript 引擎并允许脚本执行，然后再进行 DOM 构建。")]),e._v(" "),r("p",[e._v("异步和延迟属性更改此行为。")]),e._v(" "),r("ul",[r("li",[e._v("使用异步，浏览器将在继续解析 HTML 文档的同时异步下载脚本。脚本完成下载后，脚本执行时将阻止解析。")]),e._v(" "),r("li",[e._v("使用 defer，浏览器在继续解析 HTML 文档的同时异步下载脚本。该脚本在解析完成之前不会运行。")])]),e._v(" "),r("p",[e._v("如果话太多，这是一张漂亮的图片：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_13.png",alt:"可视化比较使用脚本与脚本异步与脚本延迟的影响。 在脚本提取和HTML解析完成之后，Defer显示为正在执行。"}})]),e._v(" "),r("p",[r("em",[e._v("信用：随着网络发展")])]),e._v(" "),r("p",[e._v("通常，您应始终对第三方脚本使用"),r("code",[e._v("async")]),e._v("或"),r("code",[e._v("defer")]),e._v("（除非脚本对关键渲染路径执行必要的操作）：")]),e._v(" "),r("ul",[r("li",[r("code",[e._v("async")]),e._v("如果在加载过程中较早运行脚本很重要，请使用。例如，这可能包括一些分析脚本。")]),e._v(" "),r("li",[e._v("使用"),r("code",[e._v("defer")]),e._v("更少的关键资源。例如，视频播放器在售。")])]),e._v(" "),r("p",[e._v("**注意：**如果主要考虑性能，则可以等到页面达到关键的用户时刻（例如，加载关键内容之后），然后再添加异步脚本。您还应注意不要"),r("code",[e._v("async")]),e._v("仅因为它们来自第三方 CDN 而加载 jQuery 之类的库。")]),e._v(" "),r("p",[e._v("**注：**在闪烁为基础的浏览器，"),r("code",[e._v("async")]),e._v("而"),r("code",[e._v("defer")]),e._v("目前"),r("a",{attrs:{href:"https://docs.google.com/document/d/1bCDuq9H1ih9iNjgzyAL0gpwNFiEP4TZS-YLRp_RuMlc/edit",target:"_blank",rel:"noopener noreferrer"}},[e._v("降低网络请求的优先级"),r("OutboundLink")],1),e._v(" 的资源，因此它可以导致其显著晚于它会为阻止脚本加载。特别是对于分析脚本，这很有用。")]),e._v(" "),r("p",[e._v("您是否应该不带"),r("code",[e._v("async")]),e._v("或加载第三方脚本"),r("code",[e._v("defer")]),e._v("？如果脚本是站点功能的关键部分，那么您可以为此做一个案例。例如，如果要从 CDN 加载主 UI 库或框架，则在 DevTools 中将其标记为“第三方脚本”，但应将其视为网站的重要组成部分，而不是附加组件。")]),e._v(" "),r("p",[e._v("请注意，并非所有脚本都可以异步加载。在文档中查看您正在使用的任何第三方脚本。如果您使用的脚本无法异步加载，则可能需要考虑替代方法，或者尽可能删除该脚本。某些第三方可能"),r("em",[e._v("强烈建议")]),e._v("加载其脚本同步（以领先其他脚本），即使它们可以很好地异步工作，评估评估加载第三方脚本的策略时的尽职调查也是如此。")]),e._v(" "),r("p",[e._v("**注意：**不是灵丹妙药。如果市场营销团队希望在页面上加载大量跟踪脚本，则该数量仍会引入瓶颈，从而影响用户在加载页面上投入互动的时间。 "),r("code",[e._v("async")])]),e._v(" "),r("h3",{attrs:{id:"使用资源提示减少连接建立时间"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用资源提示减少连接建立时间"}},[e._v("#")]),e._v(" 使用资源提示减少连接建立时间")]),e._v(" "),r("p",[e._v("建立与第三方来源的连接可能会花费大量时间-特别是在速度较慢的网络上。许多步骤可能会加总延迟，包括 DNS 查找，重定向以及到每个第三方服务器来处理请求的潜在往返行程。")]),e._v(" "),r("p",[e._v("您可以使用"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/resource-prioritization#preconnect",target:"_blank",rel:"noopener noreferrer"}},[e._v("资源提示，"),r("OutboundLink")],1),e._v("例如 对托管第三方脚本的域执行 DNS 查找。最终提出请求后，由于已经进行了 DNS 查找，因此可以节省时间。")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('<link rel="dns-prefetch" href="http://example.com">\n')])])]),r("p",[e._v("如果您引用的第三方域使用 HTTPS，则您可能还会考虑 这样做，因为这将执行 DNS 查找"),r("em",[e._v("并")]),e._v("解析 TCP 往返并处理 TLS 协商。这些其他步骤可能会很慢，因为它们涉及查看 SSL 证书进行验证，因此如果发现第三方设置时间是一个问题，请认真考虑“资源提示”。")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('<link rel="preconnect" href="https://cdn.example.com">\n')])])]),r("h3",{attrs:{id:"具有-iframe-的-沙盒-脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#具有-iframe-的-沙盒-脚本"}},[e._v("#")]),e._v(" 具有 iframe 的“沙盒”脚本")]),e._v(" "),r("p",[e._v("在某些情况下，可以将第三方脚本直接加载到 iframe 中。通过将此类脚本限制为 iframe，它们将不会阻止主页的执行。这与 "),r("a",{attrs:{href:"https://www.ampproject.org/learn/about-how/",target:"_blank",rel:"noopener noreferrer"}},[e._v("AMP"),r("OutboundLink")],1),e._v("将 JavaScript 排除在"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/critical-rendering-path",target:"_blank",rel:"noopener noreferrer"}},[e._v("关键路径之外的方法相同"),r("OutboundLink")],1),e._v("。请注意，这种方法仍然会阻止"),r("code",[e._v("onload")]),e._v("事件，因此请不要将关键功能附加到"),r("code",[e._v("onload")]),e._v("。")]),e._v(" "),r("p",[e._v("**注意：**Chrome 浏览器也在探索对"),r("a",{attrs:{href:"https://www.chromestatus.com/feature/5694225681219584",target:"_blank",rel:"noopener noreferrer"}},[e._v("功能策略的"),r("OutboundLink")],1),e._v("支持- "),r("a",{attrs:{href:"https://www.chromestatus.com/feature/5694225681219584",target:"_blank",rel:"noopener noreferrer"}},[e._v("功能策略"),r("OutboundLink")],1),e._v("集，允许开发人员有选择地禁用对某些浏览器功能的访问。这样可以防止第三方内容将有害行为引入网站。")]),e._v(" "),r("h3",{attrs:{id:"自托管第三方脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#自托管第三方脚本"}},[e._v("#")]),e._v(" 自托管第三方脚本")]),e._v(" "),r("p",[e._v("如果您想进一步控制脚本的加载过程，则可以选择自托管第三方脚本。例如，如果您想减少 DNS 或往返时间，请改进 HTTP 缓存标头或利用 HTTP / 2 服务器推送等高级技术。如果脚本很重要，那么自我托管可能是一个可行的考虑因素。")]),e._v(" "),r("p",[e._v("自托管可能会带来很多警告：")]),e._v(" "),r("ul",[r("li",[e._v("脚本可能会过时。这可能是一个大问题，因为它使您无法手动更新就无法获取重要的安全修复程序。")]),e._v(" "),r("li",[e._v("由于 API 的更改，自托管脚本不会获得自动更新。一个示例：一个拥有 90％的广告收入的发布商发现，由于 API 更改（自托管脚本未解释）导致广告没有投放半天，从而导致收入损失。")])]),e._v(" "),r("p",[e._v("自托管脚本的替代方法是使用"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/primers/service-workers",target:"_blank",rel:"noopener noreferrer"}},[e._v("Service Workers 对其"),r("OutboundLink")],1),e._v("进行缓存。这样可以更好地控制从网络重新提取它们的频率。这也可以用于创建加载策略，在该策略中，对非必要第三方的请求将被限制，直到页面到达关键用户时刻为止。")]),e._v(" "),r("h3",{attrs:{id:"a-b-测试较小的用户样本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#a-b-测试较小的用户样本"}},[e._v("#")]),e._v(" A / B 测试较小的用户样本")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.optimizely.com/optimization-glossary/ab-testing/",target:"_blank",rel:"noopener noreferrer"}},[e._v("A / B 测试"),r("OutboundLink")],1),e._v("（或拆分测试）是一种用于测试页面的两个版本以确定哪个版本效果最好的技术。这是通过为网站流量的不同样本启用两种变体（A 和 B）来完成的。转换率更高的页面将获胜。")]),e._v(" "),r("p",[e._v("A / B 测试是用于分析用户体验和行为的非常有用的工具。")]),e._v(" "),r("p",[e._v("但是，根据设计，A / B 测试会延迟渲染，以找出需要激活的实验。JavaScript 通常用于检查您的用户是否属于 A / B 测试实验，然后启用正确的变体。这种模式可能导致您的用户 100％被发送到昂贵的大型脚本中，即使他们不属于接受实验的样本。")]),e._v(" "),r("p",[e._v("在这种情况下，一个很好的选择是仅针对您的一部分用户群发送 A / B 测试脚本（例如 10％对 100％），理想情况下尝试确定它们是否属于服务器端的测试样本。这改善了大多数用户的加载体验，同时仍然使拆分测试成为可能。")]),e._v(" "),r("h3",{attrs:{id:"延迟加载第三方资源"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#延迟加载第三方资源"}},[e._v("#")]),e._v(" 延迟加载第三方资源")]),e._v(" "),r("p",[e._v("嵌入的第三方资源（例如广告或视频）在构建质量不佳时可能会导致页面速度降低。延迟加载只能用于在必要时加载嵌入式资源。例如，仅当用户向下滚动页面时才在页脚中投放广告。另一种模式是在加载主页内容之后但在用户可能与该页面进行交互之前延迟加载内容。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_15.png",alt:"该图显示了对于上述折页体验至关重要的资产，而对于那些次要的折旧资产却可以延迟加载的资产。"}})]),e._v(" "),r("p",[r("strong",[e._v("注意：")]),r("a",{attrs:{href:"https://github.com/aFarkas/lazysizes",target:"_blank",rel:"noopener noreferrer"}},[e._v("LazySizes"),r("OutboundLink")],1),e._v("是一个流行的 JavaScript 库，用于延迟加载图像和"),r("a",{attrs:{href:"http://afarkas.github.io/lazysizes/#examples",target:"_blank",rel:"noopener noreferrer"}},[e._v(" iframe"),r("OutboundLink")],1),e._v("。它支持 YouTube 嵌入和"),r("a",{attrs:{href:"https://github.com/aFarkas/lazysizes/tree/gh-pages/plugins/unveilhooks",target:"_blank",rel:"noopener noreferrer"}},[e._v(" 窗口小部件"),r("OutboundLink")],1),e._v("。延迟加载任何资源时，务必要小心，因为此技术通常由 JavaScript 支持，并且可能会遇到不稳定的网络连接问题。")]),e._v(" "),r("p",[e._v("DoubleClick 在其"),r("a",{attrs:{href:"https://support.google.com/dfp_premium/answer/4578089#lazyloading",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方文档中"),r("OutboundLink")],1),e._v("提供了有关如何延迟加载广告的指南。如果使用得当，延迟加载可以增加广告的整体可见度百分比。例如，MediaVine 切换到"),r("a",{attrs:{href:"https://www.mediavine.com/lazy-loading-ads-mediavine-ads-load-200-faster/",target:"_blank",rel:"noopener noreferrer"}},[e._v("延迟加载广告"),r("OutboundLink")],1),e._v(" ，页面加载速度提高了 200％。")]),e._v(" "),r("h4",{attrs:{id:"使用交叉观察器进行有效的延迟加载"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用交叉观察器进行有效的延迟加载"}},[e._v("#")]),e._v(" 使用交叉观察器进行有效的延迟加载")]),e._v(" "),r("p",[e._v("从历史上看，用于检测元素是否在视口中可见（以便延迟加载其内容）的解决方案容易出错，通常会导致浏览器变慢。解决方案经常监听 "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/Events/scroll",target:"_blank",rel:"noopener noreferrer"}},[e._v("滚动"),r("OutboundLink")],1),e._v("或 "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/Events/resize",target:"_blank",rel:"noopener noreferrer"}},[e._v("调整大小"),r("OutboundLink")],1),e._v("事件，然后使用诸如"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect",target:"_blank",rel:"noopener noreferrer"}},[e._v("getBoundingClientRect（）之"),r("OutboundLink")],1),e._v("类的 DOM API 计算元素相对于视口的位置。这可行，但效率不高。")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://developers.google.cn/web/updates/2016/04/intersectionobserver",target:"_blank",rel:"noopener noreferrer"}},[e._v("IntersectionObserver"),r("OutboundLink")],1),e._v("是一种浏览器 API，使我们能够有效地检测观察到的元素何时进入或退出浏览器的视口。了解有关如何将其用于"),r("a",{attrs:{href:"http://deanhume.com/home/blogpost/lazy-loading-images-using-intersection-observer/10163",target:"_blank",rel:"noopener noreferrer"}},[e._v("延迟加载资源的更多信息"),r("OutboundLink")],1),e._v("。LazySizes 还具有 对 IntersectionObserver 的"),r("a",{attrs:{href:"https://github.com/aFarkas/lazysizes/blob/097a9878817dd17be3366633e555f3929a7eaaf1/src/lazysizes-intersection.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("可选支持"),r("OutboundLink")],1),e._v("。")]),e._v(" "),r("h3",{attrs:{id:"分析可能很复杂"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#分析可能很复杂"}},[e._v("#")]),e._v(" 分析可能很复杂")]),e._v(" "),r("p",[e._v("Analytics 脚本绝不应减慢页面加载体验，但是如果您将加载延迟太长时间，则可能会丢失有价值的分析数据。幸运的是，有一些众所周知的模式可用于延迟初始化分析同时保留早期页面加载数据。")]),e._v(" "),r("p",[e._v("菲尔·沃尔顿（Phil Walton）的博客文章"),r("a",{attrs:{href:"https://philipwalton.com/articles/the-google-analytics-setup-i-use-on-every-site-i-build/",target:"_blank",rel:"noopener noreferrer"}},[e._v("“我在我建立的每个网站上使用的 Google Analytics（分析）设置”"),r("OutboundLink")],1),e._v(" 涵盖了一种此类 Google Analytics（分析）模式。")]),e._v(" "),r("h2",{attrs:{id:"我应该避免使用第三方脚本的哪些模式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#我应该避免使用第三方脚本的哪些模式"}},[e._v("#")]),e._v(" 我应该避免使用第三方脚本的哪些模式？")]),e._v(" "),r("h3",{attrs:{id:"避免-document-write"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#避免-document-write"}},[e._v("#")]),e._v(" 避免 document.write（）")]),e._v(" "),r("p",[e._v("第三方脚本有时会使用 "),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Document/write",target:"_blank",rel:"noopener noreferrer"}},[e._v("document.write（）"),r("OutboundLink")],1),e._v(" 来注入和加载脚本。对于某些时间未更新的旧服务尤其如此。值得庆幸的是，许多第三方都提供了一种异步加载自身的选项，该选项允许加载第三方脚本而不会阻止页面上其余内容的显示。")]),e._v(" "),r("p",[e._v("解决 document.write（）的方法是根本不使用它注入脚本。从 Chrome 53 开始，Chrome DevTools 会将警告记录在控制台中，提示您对 document.write（）的使用有问题：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_16.png",alt:"DevTools控制台警告突出显示了使用document.write（）对第三方嵌入的违规"}})]),e._v(" "),r("p",[e._v("要发现大规模使用 document.write（）的情况，您可以检查 Chrome 发生这种干预时是否发送到浏览器的"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP 标头"),r("OutboundLink")],1),e._v("。 "),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse",target:"_blank",rel:"noopener noreferrer"}},[e._v("Lighthouse"),r("OutboundLink")],1),e._v("还可以在 Lighthouse 报告中突出显示"),r("a",{attrs:{href:"https://developers.google.cn/web/tools/lighthouse/audits/document-write",target:"_blank",rel:"noopener noreferrer"}},[e._v("仍在使用 document.write（）的"),r("OutboundLink")],1),e._v("任何第三方脚本 ：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://developers.google.cn/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/images/image_17.png",alt:"Lighthouse Best Practices审核标记document.write（）的使用"}})]),e._v(" "),r("h3",{attrs:{id:"使用标签管理器-但要明智地使用它们"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#使用标签管理器-但要明智地使用它们"}},[e._v("#")]),e._v(" 使用标签管理器，但要明智地使用它们")]),e._v(" "),r("p",[e._v("**注意：**使用 GTM 时要格外小心。尽管它可以最大程度地减少第三方标签的开销，但对于拥有凭据的任何人来说，添加昂贵的标签也变得微不足道。")]),e._v(" "),r("p",[e._v("“标签”是一段代码，可让数字营销团队收集数据，设置 Cookie 或将第三方内容（例如社交媒体小部件）集成到网站中。这些标记会影响您页面的加载性能-其他网络请求，严重的 JavaScript 依赖关系，标记本身可能会占用的图像和资源。")]),e._v(" "),r("p",[e._v("随着时间的推移，管理这些标签可能会变成一团糟，因为营销团队希望增加了解用户的方式，并且工程人员试图将标签对用户体验的影响降至最低。为了保持快速体验，我们建议使用标签管理器。标签管理器：")]),e._v(" "),r("ul",[r("li",[e._v("允许从单个位置（通常是用户界面）管理许多第三方嵌入代码")]),e._v(" "),r("li",[e._v("尝试最小化需要在站点中部署多少第三方标签。")])]),e._v(" "),r("p",[e._v("**注意：**即使可以异步加载单个标签，仍然需要分别读取和执行它们。这可能意味着在页面仍在加载时请求更多数据。标记管理器通过将浏览器需要进行的调用次数减少到一个来解决此问题。")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.google.com/analytics/tag-manager/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Google"),r("OutboundLink")],1),e._v("跟踪"),r("a",{attrs:{href:"https://www.google.com/analytics/tag-manager/",target:"_blank",rel:"noopener noreferrer"}},[e._v("代码管理器"),r("OutboundLink")],1),e._v("（GTM）就是这样一种流行的跟踪代码管理器：")]),e._v(" "),r("p",[e._v("“ Google 跟踪代码管理器是一个异步代码，这意味着它执行时不会阻止其他元素在页面上呈现。它还会导致通过 Google 跟踪代码管理器部署的其他代码被异步部署，这意味着加载缓慢标签不会阻止其他跟踪标签。”")]),e._v(" "),r("p",[e._v("标记管理器可以通过减少所需的对外部资源的调用次数来提高页面加载性能-只要您"),r("strong",[e._v("不")]),e._v("获取大量标记即可。它们还允许标签在单个唯一位置收集值的方式。对于 GTM，这是"),r("a",{attrs:{href:"https://developers.google.cn/tag-manager/devguide",target:"_blank",rel:"noopener noreferrer"}},[e._v("数据层"),r("OutboundLink")],1),e._v("。如果多个第三方希望触发转化跟踪数据，则可以通过从数据层提取数据来实现。")]),e._v(" "),r("p",[r("strong",[e._v("使用标签管理器的风险")])]),e._v(" "),r("p",[e._v("使用标签管理器时，需要格外小心，以免减慢页面加载的速度。这是因为：")]),e._v(" "),r("ul",[r("li",[e._v("具有凭证和访问权限的任何人都可以轻松地不仅添加更多标签，还可以添加 他们想要的"),r("em",[e._v("任何")]),e._v(" JavaScript。尽管标签管理器可以异步加载标签，但这仍可能导致产生和执行过多的昂贵 HTTP 请求。通过仅允许一个用户发布版本，可以将其最小化。")]),e._v(" "),r("li",[e._v("任何人都可以配置太多的标签管理器"),r("a",{attrs:{href:"https://support.google.com/analytics/answer/6164470",target:"_blank",rel:"noopener noreferrer"}},[e._v("自动事件监听器"),r("OutboundLink")],1),e._v("。每个自动事件侦听器都需要执行，并且代码和网络请求越多，页面完全加载所花费的时间就越长。通过我们的性能指导，鼓励您"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/rail",target:"_blank",rel:"noopener noreferrer"}},[e._v("在 50 毫秒内响应事件"),r("OutboundLink")],1),e._v("，添加的每个标签管理器事件监听器都会吃掉该目标。")])]),e._v(" "),r("h3",{attrs:{id:"避免使用脚本污染全局范围"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#避免使用脚本污染全局范围"}},[e._v("#")]),e._v(" 避免使用脚本污染全局范围")]),e._v(" "),r("p",[e._v("注入到未知脚本中的第三方脚本有时可以加载许多自己的 JavaScript 依赖项。这可能会污染全局范围并导致页面意外损坏。")]),e._v(" "),r("p",[e._v("也不能保证从第三方加载的代码将保持与您在测试期间看到的相同。第三方可以随时推出新功能，这可能会破坏您的页面。自检，"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity",target:"_blank",rel:"noopener noreferrer"}},[e._v("子资源完整性"),r("OutboundLink")],1),e._v(" 以及安全地传输第三方代码（以减少在途修改的风险）可以在这里起到帮助作用。")]),e._v(" "),r("p",[e._v("确保对加载的第三方脚本进行仔细的审核，以确保它们是好的角色。")]),e._v(" "),r("h2",{attrs:{id:"缓解策略"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#缓解策略"}},[e._v("#")]),e._v(" 缓解策略")]),e._v(" "),r("p",[e._v("在页面上添加第三方脚本意味着对来源的信任程度。您可以采取一些策略来最小化它们对性能和安全性的影响：")]),e._v(" "),r("ul",[r("li",[e._v("**"),r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/security/encrypt-in-transit/why-https",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTPS"),r("OutboundLink")],1),e._v("**是必须的。使用 HTTPS 的网站不应让第三方使用 HTTP。包含使用 HTTP 提取的内容的 HTTPS 页面称为混合内容页面，并且会遇到"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content",target:"_blank",rel:"noopener noreferrer"}},[e._v("混合内容"),r("OutboundLink")],1),e._v(" 警告。")]),e._v(" "),r("li",[e._v("考虑 iframe 上的**"),r("a",{attrs:{href:"https://developer.mozilla.org/en/docs/Web/HTML/Element/iframe",target:"_blank",rel:"noopener noreferrer"}},[e._v("sandbox 属性"),r("OutboundLink")],1),e._v("**。从安全角度来看，这使您可以限制 iframe 可用的操作。限制包括"),r("code",[e._v("allow-scripts")]),e._v("控制上下文是否可以运行脚本。")]),e._v(" "),r("li",[e._v("考虑**"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP",target:"_blank",rel:"noopener noreferrer"}},[e._v("内容安全策略"),r("OutboundLink")],1),e._v("**（CSP）。通过服务器响应中的 HTTP 标头，您可以定义页面中受信任的行为。CSP 可用于检测和缓解某些攻击的影响，例如"),r("a",{attrs:{href:"https://en.wikipedia.org/wiki/Cross-site_scripting",target:"_blank",rel:"noopener noreferrer"}},[e._v("跨站点脚本"),r("OutboundLink")],1),e._v("（XSS）。")])]),e._v(" "),r("p",[e._v("CSP 的功能特别强大，因为它包含诸如"),r("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src",target:"_blank",rel:"noopener noreferrer"}},[e._v("script-src 之类的"),r("OutboundLink")],1),e._v("指令，这些指令 指定了有效的 JavaScript 允许源。下面是如何在实践中使用此示例：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Given this CSP header\n\nContent-Security-Policy: script-src https://example.com/\n\n// The following third-party script will not be loaded or executed\n\n<script src="https://not-example.com/js/library.js"><\/script>\n')])])]),r("h2",{attrs:{id:"结论"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[e._v("#")]),e._v(" 结论")]),e._v(" "),r("p",[e._v("由于网站比以往任何时候都依赖于第三方脚本，因此至关重要的是不要忽略第三方脚本的性能。您可以做的好事：")]),e._v(" "),r("ul",[r("li",[e._v("熟悉一些最有效的第三方脚本优化方法，例如仅加载支持异步加载模式的标记。")]),e._v(" "),r("li",[e._v("了解如何识别和修复第三方脚本加载问题。这可以帮助您收回对页面加载性能的控制。")])]),e._v(" "),r("p",[e._v("在第三方脚本优化之后，应进行脚本的实时性能监视以及与第三方提供商的通信。Web 的发展日新月异，脚本在本地观察到的性能并不能保证它在将来或在野外都能正常运行。")]),e._v(" "),r("h2",{attrs:{id:"进一步阅读"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#进一步阅读"}},[e._v("#")]),e._v(" 进一步阅读")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://csswizardry.com/2017/07/performance-and-resilience-stress-testing-third-parties/",target:"_blank",rel:"noopener noreferrer"}},[e._v("性能和弹性：对第三方进行压力测试"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/adding-interactivity-with-javascript",target:"_blank",rel:"noopener noreferrer"}},[e._v("添加与 JavaScript 的交互性"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://css-tricks.com/potential-dangers-of-third-party-javascript/",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三方脚本的潜在危险"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.twnsnd.com/posts/performant_third_party_scripts.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三方脚本如何成为网络上的表演公民"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://speakerdeck.com/csswizardry/why-fast-matters",target:"_blank",rel:"noopener noreferrer"}},[e._v("为什么要紧-CSS 向导"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.troyhunt.com/the-javascript-supply-chain-paradox-sri-csp-and-trust-in-third-party-libraries/",target:"_blank",rel:"noopener noreferrer"}},[e._v("JavaScript 供应链悖论：SRI，CSP 和第三方库中的信任"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://jakearchibald.com/2018/third-party-css-is-not-safe/",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三方 CSS 不安全"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("em",[e._v("感谢 Kenji Baheux，Jeremy Wagner，Pat Meenan，Philip Walton，Jeff Posnick 和 Cheney Tsai 的评论。")])])])}),[],!1,null,null,null);t.default=n.exports}}]);